@LSST UPS@ &&
curl -L \
    http://sourceforge.net/projects/matplotlib/files/matplotlib/matplotlib-@REPOVERSION@/matplotlib-@REPOVERSION@.tar.gz \
> @PRODUCT@-@VERSION@.tar.gz &&
gunzip < @PRODUCT@-@VERSION@.tar.gz | tar -xf - &&
product_dir=$(eups path 0)/$(eups flavor)/@PRODUCT@/@VERSION@ &&
python_version=$(python -c "import distutils.sysconfig as ds; print ds.get_python_version()") &&
if [ ! -d $product_dir ]; then
        mkdir -p $product_dir
        mkdir -p $product_dir/lib/python$python_version/site-packages
fi &&
cd @PRODUCT@-@REPOVERSION@ &&

# Apply patch
if [ @REPOVERSION@ == "1.1.1" ]; then
    git archive --format=tar --remote=git://hsca.ipmu.jp/repos/devenv/buildFiles.git HEAD matplotlib-1.1.1-setupext.patch | tar --extract --verbose
    patch -p0 setupext.py < matplotlib-1.1.1-setupext.patch || echo Unable to apply patch
fi &&

export PYTHONPATH=$product_dir/lib/python$python_version/site-packages:$PYTHONPATH &&
python setup.py install --prefix=$product_dir &&
if [ ! -d $product_dir/lib/python ]; then
   mkdir -p $product_dir/lib/python
fi &&
ln -fs $product_dir/lib/python$python_version/site-packages  $product_dir/lib/python &&
if [ $(eups flavor) = Linux64 -a -d $product_dir/lib64 ]; then
        rm -rf $product_dir/lib
        mv $product_dir/lib64 $product_dir/lib
fi &&
lsst_ups @PRODUCT@ @VERSION@ $product_dir
